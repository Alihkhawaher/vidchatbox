<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Video Summarizer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma-rtl.min.css" disabled>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="menu-container"></div>

    <!-- Main content area -->
    <div id="content" class="container is-max-desktop px-4 py-4"></div>

    <footer class="footer">
        <div class="content has-text-centered">
            <p>&copy; 2024 YouTube Video Summarizer. All rights reserved.</p>
        </div>
    </footer>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title" data-translate="settings.title">API Settings</p>
                <button class="delete close" aria-label="close"></button>
            </header>
            <section class="modal-card-body">
                <form id="settingsForm" class="settings-form">
                    <div class="field">
                        <h3 class="subtitle is-5" data-translate="settings.googleSection">Google Settings</h3>
                        <div class="field">
                            <label class="label" for="googleUsername">
                                <span>Google Username</span>
                            </label>
                            <input type="text" id="googleUsername" name="googleUsername" class="input is-hidden" autocomplete="username">
                        </div>
                        <div class="field">
                            <label class="label" for="googleApiKey">
                                <span data-translate="settings.googleApiKey">Google API Key</span>
                            </label>
                            <input type="password" id="googleApiKey" name="googleApiKey" class="input" autocomplete="new-password">
                        </div>
                    </div>
                    <div class="field">
                        <h3 class="subtitle is-5" data-translate="settings.claudeSection">Claude Settings</h3>
                        <div class="field">
                            <label class="label" for="claudeUsername">
                                <span>Claude Username</span>
                            </label>
                            <input type="text" id="claudeUsername" name="claudeUsername" class="input is-hidden" autocomplete="username">
                        </div>
                        <div class="field">
                            <label class="label" for="claudeApiKey">
                                <span data-translate="settings.claudeApiKey">Claude API Key</span>
                            </label>
                            <input type="password" id="claudeApiKey" name="claudeApiKey" class="input" autocomplete="new-password">
                        </div>
                    </div>
                    <div class="field">
                        <h3 class="subtitle is-5" data-translate="settings.debugSection">Debug Settings</h3>
                        <label class="checkbox">
                            <input type="checkbox" id="debugMode">
                            <span data-translate="settings.enableDebug">Enable Debug Mode</span>
                        </label>
                    </div>
                </form>
            </section>
            <footer class="modal-card-foot">
                <button type="submit" form="settingsForm" class="button is-primary" data-translate="settings.save">Save Settings</button>
                <button type="button" id="cancelSettings" class="button" data-translate="settings.cancel">Cancel</button>
            </footer>
        </div>
    </div>

    <!-- Debug Panel (hidden by default) -->
    <div id="debug" class="debug-panel" style="display: none;">
        <div class="debug-content"></div>
    </div>

    <!-- Load dependencies first -->
    <script src="/translations.js"></script>
    <script src="/utils.js"></script>
    
    <!-- Load core functionality -->
    <script src="/js/router.js"></script>
    <script src="/events.js"></script>

    <!-- Initialize translations -->
    <script>
        // Create a custom event for when translations are loaded
        const translationsLoaded = new Event('translationsLoaded');
        
        // Check if translations are already loaded
        if (window.translations) {
            document.dispatchEvent(translationsLoaded);
        } else {
            // Watch for translations to be loaded
            Object.defineProperty(window, 'translations', {
                set: function(value) {
                    this._translations = value;
                    console.log('Translations loaded successfully');
                    document.dispatchEvent(translationsLoaded);
                },
                get: function() {
                    return this._translations;
                }
            });
        }
    </script>
    <script>
        // Load menu first, then initialize main functionality
        document.addEventListener('DOMContentLoaded', async () => {
            // Load menu with fallback for Vercel
            async function loadMenu() {
                try {
                    const response = await fetch('/menu.html');
                    if (!response.ok) {
                        throw new Error('Failed to load menu');
                    }
                    const html = await response.text();
                    const menuContainer = document.getElementById('menu-container');
                    if (menuContainer) {
                        menuContainer.innerHTML = html;
                        // Move menu container to top if it's not already there
                        const body = document.body;
                        if (body.firstChild !== menuContainer) {
                            body.insertBefore(menuContainer, body.firstChild);
                        }
                        initializeMenu();
                    } else {
                        console.error('Menu container not found');
                    }
                } catch (error) {
                    console.error('Error loading menu:', error);
                }
            }
            
            await loadMenu();
            
            // Load main.js after menu is loaded
            const mainScript = document.createElement('script');
            mainScript.src = '/main.js';
            document.body.appendChild(mainScript);
        });

        function initializeMenu() {
            const languageSelect = document.getElementById('languageSelect');
            const settingsModal = document.getElementById('settingsModal');
            const settingsBtn = document.getElementById('settingsBtn');
            const closeBtn = document.querySelector('.close');
            const cancelBtn = document.getElementById('cancelSettings');
            const debugMode = document.getElementById('debugMode');
            const debugPanel = document.getElementById('debug');

            // Load saved debug state
            const settings = JSON.parse(localStorage.getItem('apiSettings') || '{}');
            debugMode.checked = settings.debugMode || false;
            debugPanel.style.display = debugMode.checked ? 'block' : 'none';

            // Language switching
            if (languageSelect) {
                // Set initial language from localStorage or default to 'en'
                const savedLang = localStorage.getItem('selectedLanguage') || 'en';
                languageSelect.value = savedLang;
                document.documentElement.lang = savedLang;
                document.documentElement.dir = savedLang === 'ar' ? 'rtl' : 'ltr';
                updateUILanguage(savedLang);

                // Handle language changes
                languageSelect.addEventListener('change', () => {
                    const selectedLang = languageSelect.value;
                    localStorage.setItem('selectedLanguage', selectedLang);
                    document.documentElement.lang = selectedLang;
                    document.documentElement.dir = selectedLang === 'ar' ? 'rtl' : 'ltr';
                    
                    // Toggle RTL stylesheet
                    const rtlStylesheet = document.querySelector('link[href*="bulma-rtl"]');
                    rtlStylesheet.disabled = selectedLang !== 'ar';
                    
                    updateUILanguage(selectedLang);
                });
            }

            // Settings modal
            if (settingsBtn && settingsModal) {
                const openModal = () => settingsModal.classList.add('is-active');
                const closeModal = () => settingsModal.classList.remove('is-active');

                settingsBtn.addEventListener('click', openModal);
                closeBtn.addEventListener('click', closeModal);
                cancelBtn.addEventListener('click', closeModal);
                settingsModal.querySelector('.modal-background').addEventListener('click', closeModal);

                // Handle debug mode toggle
                debugMode.addEventListener('change', (e) => {
                    debugPanel.style.display = e.target.checked ? 'block' : 'none';
                    const currentSettings = JSON.parse(localStorage.getItem('apiSettings') || '{}');
                    currentSettings.debugMode = e.target.checked;
                    localStorage.setItem('apiSettings', JSON.stringify(currentSettings));
                });

                // Handle settings form submission
                const settingsForm = document.getElementById('settingsForm');
                settingsForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const settings = {
                        googleApiKey: document.getElementById('googleApiKey').value.trim(),
                        claudeApiKey: document.getElementById('claudeApiKey').value.trim(),
                        debugMode: document.getElementById('debugMode').checked
                    };
                    
                    localStorage.setItem('apiSettings', JSON.stringify(settings));
                    const currentLang = languageSelect.value;
                    showStatus(translations[currentLang].settings.saved, 'success');
                    closeModal();
                });
            }
        }
    </script>
</body>
</html>
